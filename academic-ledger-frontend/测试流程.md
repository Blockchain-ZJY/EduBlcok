# 📋 完整测试流程

## 🎓 测试数据

### 院校信息
- **院校名称**: 北京大学
- **院校英文**: Peking University
- **院校代码**: PKU-2024

### 学生信息
- **姓名**: 张三
- **学号**: 2021001234
- **入学年份**: 2021

### 证书信息

#### 证书1 - 本科学位
- **专业**: 计算机科学与技术
- **学位**: 学士
- **有效期**: 永久有效
- **描述**: 2021级本科毕业生，GPA 3.8/4.0，获优秀毕业生称号
- **证书图片**: 准备一张学位证书图片（建议：500KB-2MB，JPG/PNG格式）

#### 证书2 - 硕士学位（可选）
- **专业**: 软件工程
- **学位**: 硕士
- **有效期**: 永久有效
- **描述**: 2024级硕士毕业生，研究方向：区块链技术，获优秀论文奖
- **证书图片**: 准备另一张学位证书图片

---

## 📝 详细测试步骤

### 阶段一：准备工作

#### 1. 准备MetaMask账户
```
账户1（管理员/院校）: 0x...（记录此地址）
账户2（学生）: 0x...（记录此地址）
```

#### 2. 准备测试图片
- 下载或制作2张学位证书图片
- 格式：JPG 或 PNG
- 大小：500KB - 2MB
- 建议尺寸：800x600 或更高

#### 3. 确认Pinata配置
- 打开 `.env` 文件
- 确认 `VITE_PINATA_JWT` 已正确配置
- 测试IPFS连接（刷新页面后查看"IPFS已连接"提示）

---

### 阶段二：部署合约

#### 1. 编译合约
```bash
forge build
```

#### 2. 部署到本地测试网
```bash
# 启动Anvil本地节点
anvil

# 新开终端，部署合约
forge script script/DeployAcademicLedger.sol --rpc-url http://localhost:8545 --broadcast
```

#### 3. 记录合约地址
```
部署成功后，记录输出的合约地址：
合约地址: 0x...
```

#### 4. 更新前端配置
打开 `academic-ledger-frontend/src/contracts/AcademicLedger.ts`
```typescript
export const CONTRACT_ADDRESS = '0x你的新合约地址';
```

#### 5. 重启前端
```bash
cd academic-ledger-frontend
npm run dev
```

---

### 阶段三：功能测试

#### ✅ 测试1：连接钱包

1. 打开浏览器 `http://localhost:5173`
2. 点击"连接钱包"
3. 选择账户1（管理员账户）
4. 确认连接

**预期结果**:
- ✅ 显示"已连接"
- ✅ 显示账户地址（完整）
- ✅ 显示"管理员"身份
- ✅ 显示"IPFS已连接"（绿色圆点）

---

#### ✅ 测试2：注册院校

1. 以**管理员身份**登录
2. 在"管理员功能"区域找到"注册院校"
3. 点击"注册院校"
4. 输入院校地址（账户1的地址）
5. 输入院校名称：`北京大学`
6. 确认交易

**预期结果**:
- ✅ 显示"成功"提示
- ✅ 交易在区块链上确认
- ✅ Console无错误

**验证**:
- 切换到账户1
- 页面应该显示"院校"身份
- 显示"欢迎，北京大学"

---

#### ✅ 测试3：注册学生

1. 切换到**账户2**（学生账户）
2. 在"访客功能"区域找到"注册为学生"
3. 点击"注册为学生"
4. 输入姓名：`张三`
5. 输入学号：`2021001234`
6. 输入元数据URI（可选）：**留空即可**
   > 💡 提示：这是用于存储学生额外信息（如照片、档案JSON）的IPFS链接。
   > 测试时可以不填写，不影响核心功能。
7. 确认交易

**预期结果**:
- ✅ 显示"注册成功"
- ✅ 页面刷新后显示"学生"身份
- ✅ 显示"欢迎，张三"

---

#### ✅ 测试4：颁发第一个证书（本科）

1. 切换回**账户1**（院校账户）
2. 在"院校功能"区域点击"颁发证书"
3. 填写表单：
   - 学生钱包地址：`账户2的地址`
   - 专业名称：`计算机科学与技术`
   - 学位层级：选择`学士`
   - 有效期：选择`永久有效`
   - 证书描述：`2021级本科毕业生，GPA 3.8/4.0，获优秀毕业生称号`
4. **上传证书图片**（点击或拖拽）
5. 确认文件已选择（显示文件名和大小）
6. 点击"颁发证书"
7. 等待IPFS上传
8. 确认区块链交易

**预期结果**:
- ✅ 显示"正在上传到IPFS..."
- ✅ Console显示：
  ```
  📤 开始上传文件到IPFS...
  ✅ 文件上传成功: bafkrei...
  📤 开始上传元数据到IPFS...
  ✅ 元数据上传成功: bafkrei...
  ⛓️ 开始在区块链上颁发证书...
  📷 图片文件IPFS哈希: bafkrei...
  ✅ 将要存储到合约的URI: ipfs://bafkrei...
  ✅ 证书颁发成功！证书ID: 1
  ```
- ✅ 弹窗显示"证书颁发成功！"
- ✅ 显示证书ID

---

#### ✅ 测试5：颁发第二个证书（硕士）

1. 保持**账户1**（院校账户）
2. 再次点击"颁发证书"
3. 填写表单：
   - 学生钱包地址：`账户2的地址`（同一个学生）
   - 专业名称：`软件工程`
   - 学位层级：选择`硕士`
   - 有效期：选择`永久有效`
   - 证书描述：`2024级硕士毕业生，研究方向：区块链技术`
4. **上传另一张证书图片**
5. 点击"颁发证书"

**预期结果**:
- ✅ 成功颁发第二个证书
- ✅ 证书ID: 2

---

#### ✅ 测试6：查看院校颁发的证书

1. 保持**账户1**（院校账户）
2. 点击"我的证书列表"
3. 查看弹窗内容

**预期结果**:
- ✅ 显示"共颁发 2 份证书"
- ✅ 显示【证书 1】详细信息
  - 证书ID: 1
  - 专业: 计算机科学与技术
  - 学位: 学士
  - 学生姓名: 张三
  - 学号: 2021001234
  - **📎 证书文档**
  - [显示第一张图片]
  - 🔗 在新窗口打开
- ✅ 显示【证书 2】详细信息
  - 证书ID: 2
  - 专业: 软件工程
  - 学位: 硕士
  - **📎 证书文档**
  - [显示第二张图片]
  - 🔗 在新窗口打开

---

#### ✅ 测试7：学生查看自己的证书

1. 切换到**账户2**（学生账户）
2. 在"学生功能"区域点击"我的证书"
3. 查看弹窗内容

**预期结果**:
- ✅ 显示学生基本信息
  - 姓名: 张三
  - 学号: 2021001234
  - 地址: [完整地址]
- ✅ 显示"证书数量: 2"
- ✅ 显示两个证书的完整信息和图片
- ✅ 每个证书都有独立的图片预览
- ✅ 每个证书都有"在新窗口打开"按钮

---

#### ✅ 测试8：验证IPFS图片

1. 在证书列表中，点击任意一个"🔗 在新窗口打开"按钮
2. 浏览器应该打开新标签页

**预期结果**:
- ✅ URL格式：`https://gateway.pinata.cloud/ipfs/bafkrei...`
- ✅ 显示完整的证书图片
- ✅ 图片可以正常加载
- ✅ 图片清晰可见

---

#### ✅ 测试9：验证信息格式化

1. 查看弹窗中的信息显示

**预期结果**:
- ✅ 所有标签右对齐，值左对齐
- ✅ 地址使用等宽字体显示
- ✅ 日期格式正确（YYYY/MM/DD）
- ✅ 分隔线清晰
- ✅ 章节标题有图标和背景色

---

#### ✅ 测试10：响应式测试

1. 调整浏览器窗口大小
2. 或使用移动设备模拟器（F12 → Toggle device toolbar）

**预期结果**:
- ✅ 在小屏幕上布局自动调整
- ✅ 图片自适应宽度
- ✅ 按钮堆叠显示
- ✅ 文字不换行
- ✅ 滚动条正常工作

---

## 🐛 常见问题排查

### 问题1: IPFS未连接
**现象**: 按钮显示灰色，提示"IPFS未连接"

**解决**:
1. 检查 `.env` 文件是否存在
2. 确认 `VITE_PINATA_JWT` 配置正确
3. 重启开发服务器：`npm run dev`
4. 硬刷新浏览器：`Ctrl + Shift + R`

---

### 问题2: 图片不显示
**现象**: 证书列表中没有图片，或显示"图片加载失败"

**排查**:
1. 打开Console，查找错误信息
2. 检查是否看到：
   ```
   ✅ 证书 1 添加图片预览: ipfs://bafkrei...
   🖼️ 发现图片标记: ipfs://bafkrei...
   ```
3. 点击"在新窗口打开"，检查IPFS网关是否正常
4. 如果IPFS网关慢，等待10-30秒

---

### 问题3: 交易失败
**现象**: 提示"Doc hash required"或其他错误

**解决**:
1. 确认已上传文件
2. 确认文件格式正确（JPG/PNG/PDF）
3. 确认文件大小<10MB
4. 查看Console的详细错误信息

---

### 问题4: 只显示一个证书的图片
**现象**: 多个证书但只有一个有图片

**原因**: 可能是旧证书URI无效

**验证**:
1. 查看Console，找到：
   ```
   📎 证书URI原始值: 1  ← 这是旧的无效URI
   📎 证书URI原始值: ipfs://bafkrei...  ← 这是新的有效URI
   ```
2. 新颁发的证书会有正确的URI和图片

---

## ✅ 测试检查清单

完成所有测试后，确认以下功能：

- [ ] 钱包连接正常
- [ ] 身份识别正确（管理员/院校/学生）
- [ ] 院校注册成功
- [ ] 学生注册成功
- [ ] 证书颁发成功（IPFS上传 + 区块链交易）
- [ ] 院校可以查看自己颁发的所有证书
- [ ] 学生可以查看自己的所有证书
- [ ] 每个证书都显示独立的图片预览
- [ ] "在新窗口打开"链接正确
- [ ] 信息格式化整齐
- [ ] 多证书支持（本科+硕士）
- [ ] 响应式布局正常
- [ ] Console无错误
- [ ] IPFS图片加载正常

---

## 📸 测试截图建议

建议截图保存以下界面：

1. ✅ 管理员界面
2. ✅ 院校界面
3. ✅ 学生界面
4. ✅ 颁发证书表单
5. ✅ 院校证书列表（含图片）
6. ✅ 学生证书列表（含图片）
7. ✅ IPFS图片在新窗口打开
8. ✅ Console日志（成功的）

---

## 🎉 测试成功标志

如果你看到：
- ✅ 两个证书都成功颁发
- ✅ 每个证书下面都有图片预览
- ✅ 点击"在新窗口打开"能看到完整图片
- ✅ 信息格式整齐，标签对齐
- ✅ Console没有错误

**恭喜！系统运行完美！** 🎊

---

## 💡 高级测试（可选）

### 测试多个学生
1. 创建账户3作为第二个学生
2. 重复学生注册和证书颁发
3. 验证院校可以查看所有学生的证书

### 测试不同文件格式
1. 上传JPG格式证书
2. 上传PNG格式证书
3. 上传PDF格式证书
4. 验证都能正确显示

### 测试网络切换
1. 切换MetaMask网络
2. 验证应用正确提示网络不匹配
3. 切换回正确网络

---

**祝测试顺利！如有任何问题，请查看Console日志并反馈！** 🚀

